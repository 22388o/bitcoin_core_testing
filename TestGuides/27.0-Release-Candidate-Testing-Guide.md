# Testing Guide: Bitcoin Core 27.0 Release Candidate

_For feedback on this guide, please visit [TBD Issue #](https://github.com/bitcoin/bitcoin/issues/TBD)_

This document outlines some of the upcoming Bitcoin Core 27.0 release changes and provides steps to help test them. This guide is meant to be the starting point for experimentation and further testing, but is in no way comprehensive! After running through the steps in this guide, you are encouraged to do your own testing.

This can be as simple as testing the same features in this guide but trying it a different way. Even better, think of features you use regularly and test that they still work as expected in the release candidate. You can also read the [release notes][release notes] to find something not covered in this guide. **This is a great way to be involved with Bitcoin's development and helps keep Bitcoin running smoothly and bug-minimized! Your help in this endeavour is greatly appreciated.**


## Overview

Changes covered in this testing guide include:

* [Mempool.dat v1/v2 compatibility](#mempool.dat v1/v2 compatibility) ([PR](https://github.com/bitcoin/bitcoin/pull/28207))

***

For a comprehensive list of changes in Bitcoin Core 27.0, check out the [release notes][release notes].

## Preparation

### 1. Grab Latest Release Candidate

**Current Release Candidate:** [Bitcoin Core 27.0rc1][source-code] ([release-notes][release notes])

There are two ways to grab the latest release candidate: pre-compiled binary or source code. The source code for the latest release can be obtained here: [latest release source code][source-code]
      
If you prefer to use a binary, make sure to [grab the correct one for your system][binaries].

[source-code]: https://github.com/bitcoin/bitcoin/releases/tag/v27.0rc1
[binaries]: https://bitcoincore.org/bin/bitcoin-core-27.0/test.rc1/
[release notes]: https://github.com/bitcoin-core/bitcoin-devwiki/wiki/27.0-Release-Notes-Draft

### 2. Compile Release Candidate

**If testing from binary (rather than building from source), skip this step**

Before compiling, make sure that your system has all the correct [dependencies][dependencies] installed and that you have checked out the correct tag:

```shell
git checkout -b v27.0r1 tags/v27.0rc1
```

For more information on compiling from source, here are some guides to compile Bitcoin Core for [UNIX/Linux](https://github.com/bitcoin/bitcoin/blob/master/doc/build-unix.md), [macOS](https://github.com/bitcoin/bitcoin/blob/master/doc/build-osx.md), [Windows](https://github.com/bitcoin/bitcoin/blob/master/doc/build-windows.md), [FreeBSD](https://github.com/bitcoin/bitcoin/blob/master/doc/build-freebsd.md), [NetBSD](https://github.com/bitcoin/bitcoin/blob/master/doc/build-netbsd.md), and [OpenBSD](https://github.com/bitcoin/bitcoin/blob/master/doc/build-openbsd.md).

[dependencies]: https://github.com/bitcoin/bitcoin/blob/master/doc/dependencies.md

### 3. Setting up command line environment

First, create a temporary data directory
```shell
export DATA_DIR=/tmp/27-rc-test
mkdir $DATA_DIR
```

Next, specify the following paths. 
If testing from source compiled source, start from the root of your release candidate directory and run:

```shell
export BINARY_PATH=$(pwd)/src
```

If testing from downloaded binary, start from the root of the downloaded release candidate (cd ~/bitcoin-27.0rc1, for example) and run:
```shell
export BINARY_PATH=$(pwd)/bin
```

To avoid specifying the data directory (`-datadir=$DATA_DIR`) on each command, below are a few extra variables to set.
```shell
alias bitcoind-test="$(echo $BINARY_PATH)/bitcoind -datadir=$DATA_DIR"
alias bcli="$(echo $BINARY_PATH)/bitcoin-cli -datadir=$DATA_DIR"
```

Once you have set up the test aliases used throughout the rest of this guide,
you can verify that they are pointing to the correct binaries by running:

```bash
bcli --version
bitcoind-teset --version
```

and verifying that both report `Bitcoin Core version v27.0rc1`.


The commands throughout the rest of the guide will look like:

```shell
bcli [cli args]
```

**Start node**
```shell
echo "regtest=1" > $DATA_DIR/bitcoin.conf
```

```shell
bitcoind-test
```

```shell
2024-03-10T22:05:26Z Bitcoin Core version TODO: UPDATE THIS VERSION
2024-03-10T22:05:26Z Script verification uses 9 additional threads
2024-03-10T22:05:26Z Using the 'standard' SHA256 implementation
2024-03-10T22:05:26Z Default data directory /home/[USER]/.bitcoin
2024-03-10T22:05:26Z Using data directory /tmp/27-rc-test/regtest
2024-03-10T22:05:26Z Config file: /tmp/27-rc-test/bitcoin.conf
2024-03-10T22:05:26Z Config file arg: regtest="1"
2024-03-10T22:05:26Z Command-line arg: datadir="/tmp/27-rc-test"
```
TODO:  UPDATE SHELL OUTPUT
Stop bitcoind
```shell
Ctrl + C
```
Inspect the ouput and ensure Release Candidate 27.0r1 was running.

For the rest of the guide bitcoind will be started in daemon mode (`-daemon`) and as such `CTRL + C` will not stop the process. Instead, use `bcli stop`.

### 4. Reset testing environment

Between sections in this guide, it's recommended to stop your node and wipe the data directory. You can use the commands provided below.

**Stop node**
```shell
bcli stop
```

**Wipe and recreate the directory**
```shell
rm -r $DATA_DIR
mkdir $DATA_DIR
```

***

## mempool.dat v1/v2 compatibility
The `mempool.dat` file created uses a new format (v2, which enhances integrity checking of `mempool.dat`), which isn't readable by previous versions of Bitcoin Core.  A temporary setting `-persistmempoolv1` allows fall back to the legacy format.

The following tests migration from the legacy v1 to the new v2 format.

Before beginning make sure you have already [stopped your node and cleaned the datadir](#4-reset-testing-environment).

We can test this on regtest:

Start the node (using legacy mempool.dat format), create a wallet, and fund it with 50 tBTC.
```shell
echo "regtest=1" > $DATA_DIR/bitcoin.conf
bitcoind-test -daemon -persistmempoolv1=1
bcli createwallet test
bcli -rpcwallet=test -generate 101
```

Expected results:
```shell
{
  "name": "test"
}
...
{
  "address": "bcrt1q[rest of address]",
  "blocks": [
    "[hash]",
    "57d09495e62df6a4e51f5ebe517b11b1913d7e9ba6dccbbbf5f3989bb2b43b37",
...
    "659b4ed5400f14c3c901fa5646b40da3be8b9d526a03d9b5b6684fd99ce82c6e",
    "79cef426a1e3a909ebc238c85498cd05c15a79442df46e2d3017f3f84f3a881e"
  ]
}
```

Create two transactions and add to the mempool, a child and parent transaction.
```shell
export ADDRESS=$(bcli -rpcwallet=test getnewaddress)
bcli -rpcwallet=test -named send outputs="{\"$ADDRESS\": 1}" fee_rate=10
bcli -rpcwallet=test -named send outputs="{\"$ADDRESS\": 1}" fee_rate=10
```

Expected results:
txids specified for each transaction.
```shell
{
  "txid": "c1a6f2cfe620e9b8b5f25215f2162d4f93bab4dd3a718cb6657abc488b864cdd",
  "complete": true
}
...
{
  "txid": "409ee34a4467d4705f98fc7fff6d33331e5941fbd438b7c7a3142f57c83b1018",
  "complete": true
}
```

Stop the node and very use of the legacy v1 format.
```shell
bcli stop
ls --full-time $DATA_DIR/regtest/mempool.dat
hexdump -n8 $DATA_DIR/regtest/mempool.dat
```
Take note of the modified date.

Expected results:
```shell
-rw------- 1 [user] [user] 558 2024-03-10 18:15:24.635375397 -0400 /tmp/27-rc-test/regtest/mempool.dat
...
0000000 0001 0000 0000 0000
0000008
```

Start the node using the new mempool.dat format (by omitting `-persistmempoolv1=1`).
Verify that the mempool contains the same two transactions created earlier.
```shell
bitcoind-test -daemon
bcli getmempoolinfo
bcli getrawmempool
```

Expected results:
```shell
{
  "loaded": true,
  "size": 2,
  "bytes": 282,
  "usage": 2416,
  "total_fee": 0.00002820,
  "maxmempool": 300000000,
  "mempoolminfee": 0.00001000,
  "minrelaytxfee": 0.00001000,
  "incrementalrelayfee": 0.00001000,
  "unbroadcastcount": 2,
  "fullrbf": false
}
...
[
  "c1a6f2cfe620e9b8b5f25215f2162d4f93bab4dd3a718cb6657abc488b864cdd",
  "409ee34a4467d4705f98fc7fff6d33331e5941fbd438b7c7a3142f57c83b1018"
]
```

Save the mempool to `mempool.dat` in the new v2 format.
Verify that `mempool.dat` has been modified, and is in the new v2 format.
```shell
bcli savemempool
ls --full-time $DATA_DIR/regtest/mempool.dat
hexdump -n8 $DATA_DIR/regtest/mempool.dat
```

Expected results:
```shell
{
  "filename": "/tmp/27-rc-test/regtest/mempool.dat"
}
...
-rw------- 1 [user] [user] 567 2024-03-10 18:18:29.098160122 -0400 /tmp/27-rc-test/regtest/mempool.dat
...
0000000 0002 0000 0000 0000                    
0000008
```

Stop the node and verify successful loading of the new v2 format.
Verify that the mempool contains the same two transactions created earlier.
```shell
bcli stop
bitcoind-test -daemon
bcli getmempoolinfo
bcli getrawmempool
```

Once the test is successful, don't forget to [stop your node and clean the datadir](#4-reset-testing-environment).

## v2 Transport on by Default

Bitcoin Core 27.0 enables v2 P2P Transport [by
default](https://github.com/bitcoin/bitcoin/pull/29347) for automatic connections, and for
many of   


### Testing manual connections

For the following manual v2 connection tests, we will want to connect to signet nodes
that support V2 transport. Two such nodes that we will use in the examples below are:

**FIXME: get more addresses for this list, the second address does not do v2 AFAICT.**
- `bitcoin.achow101.com:38333`
- `175.45.182.145:38333`

Before the following tests, let's add signet=1 the bitcoin.conf to use the signet
network for testing, and turn off DNS seeds and fixed seeds so that we have more control
over who we connect to. We will also use `debug=net` to enable logging of `net` messages.

``` bash
{
echo "signet=1"
echo "dnsseed=0"
echo "fixedseeds=0"
echo "debug=net"
} > $DATA_DIR/bitcoin.conf
```

#### Seeding from a V2 connection

First, let's try using a v2 seednode to fill up our peer address book (`addrman`):

``` bash
bitcoind-test -daemon -seednode=bitcoin.achow101.com:38333
```

After ~30 seconds, use the `getpeerinfo` rpc to make sure your node has succeeded in
bootstrapping its connection from the seed node:

<details>

<summary>

```bash
bcli getpeerinfo
```

</summary>

```json5
[
  {
    "id": 1,
    // [...]
    "network": "ipv4",
    // [...]
    "subver": "/Satoshi:26.0.0/",
    // [...]
    "connection_type": "outbound-full-relay",
    "transport_protocol_type": "v1",
    "session_id": ""
  },
  {
    "id": 2,
    // [...]
    "network": "ipv6",
    // [...]
    "subver": "/Satoshi:26.0.0/",
    // [...]
    "connection_type": "outbound-full-relay",
    "transport_protocol_type": "v1",
    "session_id": ""
  },
  // [...]
]
```

</details>

To ensure that you have successfully made an `addrfetch` connection to the seed node using
v2 Transport, you can view logs related to `v2` and `peer=0` with the following:

<details> 

<summary>

```bash
cat $DATA_DIR/signet/debug.log | grep "v2\|peer=0"
```

</summary>

```console
2024-03-16T17:15:05Z Bitcoin Core version v27.0rc1 (release build)
2024-03-16T17:15:05Z [net] trying v2 connection bitcoin.achow101.com:38333 lastseen=0.0hrs
2024-03-16T17:15:05Z [net] Added connection peer=0
2024-03-16T17:15:05Z [net] sending version (102 bytes) peer=0
2024-03-16T17:15:05Z [net] send version message: version 70016, blocks=0, txrelay=1, peer=0
2024-03-16T17:15:05Z [net] start sending v2 handshake to peer=0
2024-03-16T17:15:05Z [net] received: version (103 bytes) peer=0
2024-03-16T17:15:05Z [net] sending wtxidrelay (0 bytes) peer=0
2024-03-16T17:15:05Z [net] sending sendaddrv2 (0 bytes) peer=0
2024-03-16T17:15:05Z [net] sending verack (0 bytes) peer=0
2024-03-16T17:15:05Z [net] sending getaddr (0 bytes) peer=0
2024-03-16T17:15:05Z [net] receive version message: /Satoshi:27.99.0/: version 70016, blocks=187042, us=76.151.248.21:49556, txrelay=1, peer=0
2024-03-16T17:15:05Z [net] received: wtxidrelay (0 bytes) peer=0
2024-03-16T17:15:05Z [net] received: sendaddrv2 (0 bytes) peer=0
2024-03-16T17:15:05Z [net] received: verack (0 bytes) peer=0
2024-03-16T17:15:05Z New addr-fetch v2 peer connected: version: 70016, blocks=187042, peer=0
2024-03-16T17:15:05Z [net] sending sendcmpct (9 bytes) peer=0
2024-03-16T17:15:05Z [net] sending ping (8 bytes) peer=0
2024-03-16T17:15:05Z [net] sending feefilter (8 bytes) peer=0
2024-03-16T17:15:05Z [net] received: sendcmpct (9 bytes) peer=0
2024-03-16T17:15:05Z [net] received: ping (8 bytes) peer=0
2024-03-16T17:15:05Z [net] sending pong (8 bytes) peer=0
2024-03-16T17:15:05Z [net] received: getheaders (965 bytes) peer=0
2024-03-16T17:15:05Z [net] Ignoring getheaders from peer=0 because active chain has too little work; sending empty response
2024-03-16T17:15:05Z [net] sending headers (1 bytes) peer=0
2024-03-16T17:15:05Z [net] received: feefilter (8 bytes) peer=0
2024-03-16T17:15:05Z [net] received: feefilter of 0.00001000 BTC/kvB from peer=0
2024-03-16T17:15:05Z [net] received: addrv2 (19582 bytes) peer=0
2024-03-16T17:15:05Z [net] Received addr: 999 addresses (999 processed, 0 rate-limited) from peer=0
2024-03-16T17:15:05Z [net] addrfetch connection completed peer=0; disconnecting
2024-03-16T17:15:06Z [net] disconnecting peer=0
2024-03-16T17:15:06Z [net] Cleared nodestate for peer=0
```

</details>

Some lines of note in the above output from `debug.log`:
    - `trying v2 connection <peer host or ip>:38333`: Indicates that we attempted to
      initiate the connection over v2
    - `New addr-fetch v2 peer connected // [...] peer=0` which indicates that the v2 peer
      handshake has succeeded and we have connected to the seed node as an `addr-fetch`
      peer
    - `Received addr: <number of addresses> from peer=0`
    - `addrfetch connection complete peer=0`

#### Adding a peer manually

Now let's try to add a manual connection to a v2 capable peer and make sure that Bitcoin
Core succesfully makes a v2 connection to them.

> ☝ We can probably reuse the address or hostname we used as our `-seednode` since addrfetch
> connections are terminated once they've given us enough peers. If you decide to reuse the
> same v2 peer that you seeded from, use `getpeerinfo` to make sure they are not one of our
> curent connections, and if they are, use `disconnectnode` to drop them.


```bash
bcli addnode 175.45.182.145:38333 add
```

Check that our manual `addnode` connection succeeded with `getaddednodeinfo`:

<details>

<summary>

```bash
bcli getaddednodeinfo
```

</summary>

```json5
[
  {
    "addednode": "175.45.182.145:38333",
    "connected": true,
    "addresses": [
      {
        "address": "175.45.182.145:38333",
        "connected": "outbound"
      }
    ]
  }
]
```

</details>

Now verify that your connection to the added node is a v2 connection using `getpeerinfo`.

<details>

<summary>

```bash
bcli getpeerinfo
```

</summary>

```json5
{
    "id": 18,
    "addr": "<hostname/ip>:38333",
    "servicesnames": [
      "NETWORK",
      "WITNESS",
      "COMPACT_FILTERS",
      "NETWORK_LIMITED",
      "P2P_V2"
    ],

    // [...]

    "connection_type": "manual",
    "transport_protocol_type": "v2",
    "session_id": "92e0c037b75edf14d0e85032f5aedc8ff450e1b708bd03ceee38eef065dd5e87"
  },
```

</details>

Once the test is successful, don't forget to [stop your node and clean the datadir](#4-reset-testing-environment).

## v3 Transaction Policy

**FIXME: See https://github.com/bitcoin/bitcoin/blob/master/test/functional/mempool_accept_v3.py for test ideas.


## `migratewallet` RPC is no longer experimental


## `assumeutxo` script `utxo_snapshot.sh` and `dumpttxoutset`


If you are interested in learning more about v2 Transport, we encourage you
to read [BIP324](https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki) and
the [BIP324 tracking issue](https://github.com/bitcoin/bitcoin/issues/27634).

***

Kudos if you make it this far 👏🎉

Thanks for your contribution and for taking the time to make Bitcoin awesome. For feedback on this guide, please visit [TBD ISSUE NUM](https://github.com/bitcoin/bitcoin/issues/NUMBER)

***

Many thanks to [USER](https://github.com/USER) for their input and review on this document.
