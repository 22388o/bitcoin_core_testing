# Testing Guide: Bitcoin Core 27.0 Release Candidate

_For feedback on this guide, please visit [TBD Issue #](https://github.com/bitcoin/bitcoin/issues/TBD)_

This document outlines some of the upcoming Bitcoin Core 27.0 release changes and provides steps to help test them. This guide is meant to be the starting point for experimentation and further testing, but is in no way comprehensive! After running through the steps in this guide, you are encouraged to do your own testing.

This can be as simple as testing the same features in this guide but trying it a different way. Even better, think of features you use regularly and test that they still work as expected in the release candidate. You can also read the [release notes][release notes] to find something not covered in this guide. **This is a great way to be involved with Bitcoin's development and helps keep Bitcoin running smoothly and bug-minimized! Your help in this endeavour is greatly appreciated.**


## Overview

Changes covered in this testing guide include:

* [Mempool.dat v1/v2 compatibility](#mempool.dat v1/v2 compatibility) ([PR](https://github.com/bitcoin/bitcoin/pull/28207))

***

For a comprehensive list of changes in Bitcoin Core 27.0, check out the [release notes][release notes].

## Preparation

### 1. Grab Latest Release Candidate

**Current Release Candidate:** [Bitcoin Core 27.0rc1][source-code] ([release-notes][release notes])

There are two ways to grab the latest release candidate: pre-compiled binary or source code. The source code for the latest release can be obtained here: [latest release source code][source-code]
      
If you prefer to use a binary, make sure to [grab the correct one for your system][binaries].

[source-code]: https://github.com/bitcoin/bitcoin/releases/tag/v27.0rc1
[binaries]: https://bitcoincore.org/bin/bitcoin-core-27.0/test.rc1/
[release notes]: https://github.com/bitcoin-core/bitcoin-devwiki/wiki/27.0-Release-Notes-Draft

### 2. Compile Release Candidate

**If testing from binary (rather than building from source), skip this step**

Before compiling, make sure that your system has all the correct [dependencies][dependencies] installed and that you have checked out the correct tag:

```shell
git checkout -b v27.0r1 tags/v27.0rc1
```

For more information on compiling from source, here are some guides to compile Bitcoin Core for [UNIX/Linux](https://github.com/bitcoin/bitcoin/blob/master/doc/build-unix.md), [macOS](https://github.com/bitcoin/bitcoin/blob/master/doc/build-osx.md), [Windows](https://github.com/bitcoin/bitcoin/blob/master/doc/build-windows.md), [FreeBSD](https://github.com/bitcoin/bitcoin/blob/master/doc/build-freebsd.md), [NetBSD](https://github.com/bitcoin/bitcoin/blob/master/doc/build-netbsd.md), and [OpenBSD](https://github.com/bitcoin/bitcoin/blob/master/doc/build-openbsd.md).

[dependencies]: https://github.com/bitcoin/bitcoin/blob/master/doc/dependencies.md

### 3. Setting up command line environment

First, create a temporary data directory
```shell
export DATA_DIR=/tmp/27-rc-test
mkdir $DATA_DIR
```

Next, specify the following paths. 
If testing from source compiled source, start from the root of your release candidate directory and run:

```shell
export BINARY_PATH=$(pwd)/src
```

If testing from downloaded binary, start from the root of the downloaded release candidate (cd ~/bitcoin-27.0rc1, for example) and run:
```shell
export BINARY_PATH=$(pwd)/bin
```

To avoid specifying the data directory (`-datadir=$DATA_DIR`) on each command, below are a few extra variables to set.
```shell
alias bitcoind-test="$(echo $BINARY_PATH)/bitcoind -datadir=$DATA_DIR"
alias bcli="$(echo $BINARY_PATH)/bitcoin-cli -datadir=$DATA_DIR"
```

The commands throughout the rest of the guide will look like:

```shell
bcli [cli args]
```

**Start node**
```shell
echo "regtest=1" > $DATA_DIR/bitcoin.conf
```

```shell
bitcoind-test
```

```shell
2024-03-10T22:05:26Z Bitcoin Core version TODO: UPDATE THIS VERSION
2024-03-10T22:05:26Z Script verification uses 9 additional threads
2024-03-10T22:05:26Z Using the 'standard' SHA256 implementation
2024-03-10T22:05:26Z Default data directory /home/[USER]/.bitcoin
2024-03-10T22:05:26Z Using data directory /tmp/27-rc-test/regtest
2024-03-10T22:05:26Z Config file: /tmp/27-rc-test/bitcoin.conf
2024-03-10T22:05:26Z Config file arg: regtest="1"
2024-03-10T22:05:26Z Command-line arg: datadir="/tmp/27-rc-test"
```
TODO:  UPDATE SHELL OUTPUT
Stop bitcoind
```shell
Ctrl + C
```
Inspect the ouput and ensure Release Candidate 27.0r1 was running.

For the rest of the guide bitcoind will be started in daemon mode (`-daemon`) and as such `CTRL + C` will not stop the process. Instead, use `bcli stop`.

### 4. Reset testing environment

Between sections in this guide, it's recommended to stop your node and wipe the data directory. You can use the commands provided below.

**Stop node**
```shell
bcli stop
```

**Wipe and recreate the directory**
```shell
rm -r $DATA_DIR
mkdir $DATA_DIR
```

***

## mempool.dat v1/v2 compatibility
The `mempool.dat` file created uses a new format (v2), which isn't readable by previous versions of Bitcoin Core.  A temporary setting `-persistmempoolv1` allows fall back to the legacy format.

The following tests migration from the legacy v1 to the new v2 format.

Before beginning make sure you have already [stopped your node and cleaned the datadir](#4-reset-testing-environment).

We can test this on regtest:

Start the node (using legacy mempool.dat format), create a wallet, and fund it with 50 tBTC.
```shell
echo "regtest=1" > $DATA_DIR/bitcoin.conf
bitcoind-test -daemon -persistmempoolv1=1
bcli createwallet test
bcli -rpcwallet=test -generate 101
```

Expected results:
```shell
{
  "name": "test"
}
...
{
  "address": "bcrt1q[rest of address]",
  "blocks": [
    "[hash]",
    "57d09495e62df6a4e51f5ebe517b11b1913d7e9ba6dccbbbf5f3989bb2b43b37",
...
    "659b4ed5400f14c3c901fa5646b40da3be8b9d526a03d9b5b6684fd99ce82c6e",
    "79cef426a1e3a909ebc238c85498cd05c15a79442df46e2d3017f3f84f3a881e"
  ]
}
```

Create two transactions and add to the mempool, a child and parent transaction.
```shell
export ADDRESS=$(bcli -rpcwallet=test getnewaddress)
bcli -rpcwallet=test -named send outputs="{\"$ADDRESS\": 1}" fee_rate=10
bcli -rpcwallet=test -named send outputs="{\"$ADDRESS\": 1}" fee_rate=10
```

Expected results:
txids specified for each transaction.
```shell
{
  "txid": "c1a6f2cfe620e9b8b5f25215f2162d4f93bab4dd3a718cb6657abc488b864cdd",
  "complete": true
}
...
{
  "txid": "409ee34a4467d4705f98fc7fff6d33331e5941fbd438b7c7a3142f57c83b1018",
  "complete": true
}
```

Stop the node and very use of the legacy v1 format.
```shell
bcli stop
ls --full-time $DATA_DIR/regtest/mempool.dat
hexdump -n8 $DATA_DIR/regtest/mempool.dat
```
Take note of the modified date.

Expected results:
```shell
-rw------- 1 [user] [user] 558 2024-03-10 18:15:24.635375397 -0400 /tmp/27-rc-test/regtest/mempool.dat
...
0000000 0001 0000 0000 0000
0000008
```

Start the node using the new mempool.dat format (by omitting `-persistmempoolv1=1`).
Verify that the mempool contains the same two transactions created earlier.
```shell
bitcoind-test -daemon
bcli getmempoolinfo
bcli getrawmempool
```

Expected results:
```shell
{
  "loaded": true,
  "size": 2,
  "bytes": 282,
  "usage": 2416,
  "total_fee": 0.00002820,
  "maxmempool": 300000000,
  "mempoolminfee": 0.00001000,
  "minrelaytxfee": 0.00001000,
  "incrementalrelayfee": 0.00001000,
  "unbroadcastcount": 2,
  "fullrbf": false
}
...
[
  "c1a6f2cfe620e9b8b5f25215f2162d4f93bab4dd3a718cb6657abc488b864cdd",
  "409ee34a4467d4705f98fc7fff6d33331e5941fbd438b7c7a3142f57c83b1018"
]
```

Save the mempool to `mempool.dat` in the new v2 format.
Verify that `mempool.dat` has been modified, and is in the new v2 format.
```shell
bcli savemempool
ls --full-time $DATA_DIR/regtest/mempool.dat
hexdump -n8 $DATA_DIR/regtest/mempool.dat
```

Expected results:
```shell
{
  "filename": "/tmp/27-rc-test/regtest/mempool.dat"
}
...
-rw------- 1 [user] [user] 567 2024-03-10 18:18:29.098160122 -0400 /tmp/27-rc-test/regtest/mempool.dat
...
0000000 0002 0000 0000 0000                    
0000008
```

Stop the node and verify successful loading of the new v2 format.
Verify that the mempool contains the same two transactions created earlier.
```shell
bcli stop
bitcoind-test -daemon
bcli getmempoolinfo
bcli getrawmempool
```

Once the test is successful, don't forget to [stop your node and clean the datadir](#4-reset-testing-environment).

## v2 Transport on by Default

Bitcoin Core 27.0 enables v2 P2P Transport [by default](https://github.com/bitcoin/bitcoin/pull/29347).

### Testing manual connections

For the following manual v2 connection tests, we will want to connect to signet nodes
that support V2 transport. Two such nodes that we will use in the examples below are:
- `bitcoin.achow101.com:38333`
- `175.45.182.145:38333`

Before the following tests, let's add signet=1 the bitcoin.conf to use the signet
network for testing, and turn off DNS seeds and fixed seeds.

``` bash
{
echo "signet=1"
dnsseed=0
fixedseeds=0
echo "debug=addrman"
echo "debug=net"
} > $DATA_DIR/bitcoin.conf
```

#### Seeding from a V2 connection

First, let's try using a v2 seednode to fill up our peer address book (`addrman`):

``` bash
bitcoind-test -daemon -seednode=bitcoin.achow101.com:38333
```
**FIXME: maybe there's something I don't understand about `addrfetch` connections,
bitcoind logs a successful v2 seed connection, but `getpeerinfo` doesn't report
any addrfetch conns -DG**

Run `getpeerinfo` and make sure that you have been able to get some peers from the seed 
node.

```bash
bcli getpeerinfo
```

#### Adding a peer manually

```
bcli stop
bitcoind-test -daemon
```

``` bash
bcli addnode bitcoin.achow101.com:38333 add
```

Check that you have successfully connected using V2 Transport:

```bash
bcli getpeerinfo

[
  ...
  {
    "id": 15,
    "addr": "bitcoin.achow101.com:38333",
    ...
    "connection_type": "manual",
    "transport_protocol_type": "v2",
    "session_id": "7c081213779063150191fe0295da0dd18d95c9b4dc67809cc4ed9fb9e112ca71"
  }
]
```

To view anything related to v2 Transport in the logs:

```bash
cat $DATA_DIR/signet/debug.log | grep v2
```

Once the test is successful, don't forget to [stop your node and clean the datadir](#4-reset-testing-environment).

If you are interested in learning more about v2 Transport, we encourage you
to read [BIP324](https://github.com/bitcoin/bips/blob/master/bip-0324.mediawiki) and
the [BIP324 tracking issue](https://github.com/bitcoin/bitcoin/issues/27634).

***

Kudos if you make it this far 👏🎉

Thanks for your contribution and for taking the time to make Bitcoin awesome. For feedback on this guide, please visit [TBD ISSUE NUM](https://github.com/bitcoin/bitcoin/issues/NUMBER)

***

Many thanks to [USER](https://github.com/USER) for their input and review on this document.
